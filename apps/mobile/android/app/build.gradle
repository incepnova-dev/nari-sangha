apply plugin: "com.android.application"
apply plugin: "com.facebook.react"

// Determine React Native location (monorepo root or local)
def rootNodeModules = file("$rootDir/../../../node_modules")
def localNodeModules = file("$rootDir/../../node_modules")
def nodeModulesBase = rootNodeModules.exists() ? rootNodeModules : localNodeModules
def reactNativeDirPath = file("${nodeModulesBase}/react-native")

react {
    /* Autolinking */
    // Enable New Architecture to build required native libraries
    newArchEnabled = true
    // Configure React Native directory for monorepo
    reactNativeDir.set(reactNativeDirPath)
}

def enableProguardInReleaseBuilds = false
def jscFlavor = 'org.webkit:android-jsc:+'

android {
    ndkVersion rootProject.ext.ndkVersion

    compileSdk rootProject.ext.compileSdkVersion

    namespace "com.narisangha"
    
    defaultConfig {
        applicationId "com.narisangha"
        minSdkVersion rootProject.ext.minSdkVersion
        targetSdkVersion rootProject.ext.targetSdkVersion
        versionCode 1
        versionName "1.0"
        // New Architecture enabled to build required libraries
        buildConfigField "boolean", "IS_NEW_ARCHITECTURE_ENABLED", "true"
    }
    
    signingConfigs {
        debug {
            storeFile file('debug.keystore')
            storePassword 'android'
            keyAlias 'androiddebugkey'
            keyPassword 'android'
        }
    }
    
    buildTypes {
        debug {
            signingConfig signingConfigs.debug
        }
        release {
            signingConfig signingConfigs.debug
            minifyEnabled enableProguardInReleaseBuilds
            proguardFiles getDefaultProguardFile("proguard-android.txt"), "proguard-rules.pro"
        }
    }
    
    sourceSets {
        main {
            java {
                srcDirs = ['src/main/java']
            }
        }
    }
    
    packaging {
        pickFirst 'lib/x86/libc++_shared.so'
        pickFirst 'lib/x86_64/libc++_shared.so'
        pickFirst 'lib/armeabi-v7a/libc++_shared.so'
        pickFirst 'lib/arm64-v8a/libc++_shared.so'
    }
}

// Ensure autolinking.json exists before build
task generateAutolinkingJson(type: Exec) {
    description = 'Generate autolinking.json file'
    workingDir = rootProject.projectDir.parentFile
    commandLine = ['node', 'scripts/generate-autolinking.js']
    doFirst {
        println "Generating autolinking.json..."
    }
}

preBuild.dependsOn generateAutolinkingJson

// Generate test summary after tests complete
tasks.matching { it.name.startsWith('test') && it.name.endsWith('UnitTest') }.configureEach {
    finalizedBy rootProject.tasks.generateTestSummary
}

dependencies {
    implementation("com.facebook.react:react-android")

    if (rootProject.ext.hermesEnabled.toBoolean()) {
        implementation("com.facebook.react:hermes-android")
    } else {
        implementation jscFlavor
    }

    // Test dependencies
    testImplementation 'junit:junit:4.13.2'
    testImplementation 'org.mockito:mockito-core:5.1.1'
    testImplementation 'org.mockito:mockito-inline:5.1.1'
    testImplementation 'androidx.test:core:1.5.0'
    testImplementation 'androidx.test.ext:junit:1.1.5'
    testImplementation 'org.robolectric:robolectric:4.11.1'
    testImplementation 'androidx.test:runner:1.5.2'
    testImplementation 'androidx.test:rules:1.5.0'
}

