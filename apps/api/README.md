# Nari Sangha API

Backend API built with Express.js, TypeScript, PostgreSQL, Prisma, Zod, Jest, and JWT authentication.

## Features

- ✅ Express.js with TypeScript
- ✅ PostgreSQL database with Prisma ORM
- ✅ Zod validation
- ✅ JWT authentication
- ✅ Jest + Supertest for testing
- ✅ Security middleware (Helmet, CORS, Rate Limiting)
- ✅ Error handling
- ✅ Environment configuration

## Prerequisites

- Node.js (v18 or higher)
- PostgreSQL (v14 or higher)
- npm or yarn

## Installation

1. Install dependencies:
```bash
npm install
```

2. Set up environment variables:
```bash
cp .env.example .env
```

Edit `.env` and update the following:
- `DATABASE_URL`: Your PostgreSQL connection string (see Database Setup below)
- `JWT_SECRET`: A secure random string (at least 32 characters)
  - Generate one automatically: `./scripts/generate-jwt-secret.sh`
  - Or manually: `node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"`
- `PORT`: Server port (default: 3001)
- `CORS_ORIGIN`: Allowed CORS origin

3. Set up the database (see [Database Setup](#database-setup) section below)

4. Generate Prisma Client and run migrations:
```bash
# Generate Prisma Client
npm run prisma:generate

# Run migrations
npm run prisma:migrate
```

## Running the Application

### Development
```bash
npm run dev
```

### Production
```bash
npm run build
npm start
```

## Database Setup

### Automatic Setup (Recommended)

Use the provided setup script to automatically create the database user and database:

```bash
# Make sure PostgreSQL is running first
brew services start postgresql@16

# Run the setup script (either way works)
npm run db:setup
# OR
./scripts/setup-database.sh
```

The script will:
- Parse your `DATABASE_URL` from `.env` file
- Create the PostgreSQL user (if it doesn't exist)
- Create the database (if it doesn't exist)
- Grant necessary privileges

### Manual Setup

If you prefer to set up the database manually:

1. **Start PostgreSQL:**
   ```bash
   brew services start postgresql@16
   ```

2. **Connect to PostgreSQL:**
   ```bash
   # Add PostgreSQL to PATH if needed
   export PATH="/opt/homebrew/opt/postgresql@16/bin:$PATH"
   
   # Connect (use your macOS username or 'postgres')
   psql postgres
   ```

3. **Create user and database:**
   ```sql
   -- Replace 'user' and 'password' with values from your DATABASE_URL
   CREATE USER user WITH PASSWORD 'password';
   ALTER USER user CREATEDB;
   CREATE DATABASE nari_sangha OWNER user;
   GRANT ALL PRIVILEGES ON DATABASE nari_sangha TO user;
   \q
   ```

4. **Verify your DATABASE_URL in `.env`:**
   ```
   DATABASE_URL="postgresql://user:password@localhost:5432/nari_sangha?schema=public"
   ```

### Database Management

#### PostgreSQL Service Management

**Start PostgreSQL:**
```bash
brew services start postgresql@16
```

**Stop PostgreSQL:**
```bash
brew services stop postgresql@16
```

**Check PostgreSQL status:**
```bash
brew services list | grep postgresql
```

#### Prisma Commands

**Prisma Studio (Database GUI):**
```bash
npm run prisma:studio
```

**Create a new migration:**
```bash
npm run prisma:migrate
```

**Reset database (⚠️ deletes all data):**
```bash
npx prisma migrate reset
```

**Seed database with sample data:**
```bash
npm run db:seed
```

This will insert 10 sample user records into the database. Each user gets a unique CUID (Collision-resistant Unique Identifier) automatically generated by Prisma.


## Testing

Run all tests:
```bash
npm test
```

Run tests in watch mode:
```bash
npm run test:watch
```

Run tests with coverage:
```bash
npm run test:coverage
```

## API Endpoints

### Authentication

- `POST /api/auth/register` - Register a new user
  - Body: `{ email, password, name? }`
  
- `POST /api/auth/login` - Login user
  - Body: `{ email, password }`
  
- `GET /api/auth/profile` - Get user profile (requires authentication)
  - Headers: `Authorization: Bearer <token>`

### Health Check

- `GET /api/health` - API health status

## Project Structure

```
src/
├── config/          # Configuration files (database, env)
├── controllers/     # Route controllers
├── middleware/      # Express middleware (auth, validation, error handling)
├── routes/          # API routes
├── utils/           # Utility functions (JWT, password hashing)
├── validators/      # Zod validation schemas
└── __tests__/       # Test files
```

## Environment Variables

- `PORT` - Server port (default: 3001)
- `NODE_ENV` - Environment (development, production, test)
- `DATABASE_URL` - PostgreSQL connection string (format: `postgresql://user:password@host:port/database?schema=public`)
- `JWT_SECRET` - Secret key for JWT tokens (must be at least 32 characters)
- `JWT_EXPIRES_IN` - JWT expiration time (default: 7d)
- `CORS_ORIGIN` - Allowed CORS origin (default: http://localhost:3001)

## Security Features

- Password hashing with bcrypt
- JWT token authentication
- Helmet for security headers
- CORS configuration
- Rate limiting
- Input validation with Zod

## License

ISC

